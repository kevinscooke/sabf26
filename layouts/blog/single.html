{{ define "main" }}
{{/* Resolve cover image from common front-matter keys */}}
{{ $img := "" }}
{{ with .Params.cover }}{{ $img = . }}{{ else }}
  {{ with .Params.featured_image }}{{ $img = . }}{{ else }}
    {{ with .Params.hero }}{{ $img = . }}{{ else }}
      {{ with .Params.images }}{{ $img = index . 0 }}{{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<article class="mx-auto max-w-6xl px-4 py-10">
  {{ if $img }}
    <div class="grid gap-8 lg:grid-cols-12">
      <!-- Sidebar (sticky on desktop) -->
      <aside class="order-2 lg:order-1 lg:col-span-5">
        <div class="lg:sticky lg:top-24 lg:max-h-[calc(100vh-6rem)] lg:overflow-auto lg:pr-2">
          <!-- Cover image -->
          <div class="overflow-hidden rounded-2xl bg-gray-100">
            <img
              src="{{ $img | relURL }}"
              alt="{{ with .Params.cover_alt }}{{ . }}{{ else }}{{ .Title }} cover{{ end }}"
              class="aspect-[4/3] h-auto w-full object-cover"
              loading="lazy" decoding="async"
            >
          </div>

          <!-- Desktop-only marketing/quick links + related -->
          <div class="mt-6 hidden lg:block space-y-4">
            <!-- CTA: quick audit -->
            <div class="rounded-2xl border bg-white p-4 shadow-sm">
              <h3 class="text-sm font-semibold text-gray-900">Get a quick win</h3>
              <p class="mt-1 text-sm text-gray-600">
                Free 5-minute audit: speed, SEO, and conversion tips for your site.
              </p>
              <a href="/contact/" class="mt-3 inline-flex items-center rounded-lg bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700">
                Request an audit
              </a>
            </div>

            <!-- Quick links -->
            <nav class="rounded-2xl border bg-white p-4 shadow-sm">
              <h3 class="text-sm font-semibold text-gray-900">Quick links</h3>
              <ul class="mt-2 space-y-2 text-sm text-gray-700">
                <li><a href="/services/eCommerce/" class="hover:underline">eCommerce</a></li>
                <li><a href="/services/static/" class="hover:underline">Static Websites</a></li>
                <li><a href="/services/hugo/" class="hover:underline">Hugo Static Sites</a></li>
                <li><a href="/services/ai/" class="hover:underline">AI Concierge & Automation</a></li>
              </ul>
            </nav>

            <!-- Related posts (robust: handles tags as string or array, no chained where pipes) 
{{ $cur := . }}
{{ $raw := .Params.tags }}
{{ if $raw }}
  {{/* Coerce tags to a slice if a single string was used */}}
  {{ $tags := $raw }}
  {{ if eq (printf "%T" $raw) "string" }}{{ $tags = slice $raw }}{{ end }}

  {{/* Build candidate set in steps to avoid piping gotchas */}}
  {{ $pages := $cur.Site.RegularPages }}
  {{ $candidates := where $pages "Section" $cur.Section }}
  {{ $candidates = where $candidates "RelPermalink" "ne" $cur.RelPermalink }}

  {{/* Intersect tags and take up to 3 */}}
  {{ $related := where $candidates "Params.tags" "intersect" $tags | first 3 }}
  {{ if gt (len $related) 0 }}
    <div class="rounded-2xl border bg-white p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-gray-900">Related reads</h3>
      <ul class="mt-2 space-y-2 text-sm">
        {{ range $related }}
          <li>
            <a href="{{ .RelPermalink }}" class="hover:underline">{{ .Title }}</a>
            <span class="ml-2 text-gray-400">· {{ .Date.Format "Jan 2, 2006" }}</span>
          </li>
        {{ end }}
      </ul>
    </div>
  {{ end }}
{{ end }} -->

          </div>
        </div>
      </aside>

      <!-- Content column -->
      <div class="order-1 lg:order-2 lg:col-span-7">
        <header class="mb-8">
          <a href="/blog/" class="text-sm text-gray-500 hover:underline">← Back to Blog</a>
          <h1 class="mt-2 text-4xl font-bold tracking-tight">{{ .Title }}</h1>
          <div class="mt-2 text-sm text-gray-500">
            <time datetime="{{ .Date }}">{{ .Date.Format "Jan 2, 2006" }}</time>
            <span aria-hidden="true"> • </span>{{ .ReadingTime }} min read
          </div>
          {{ with .Params.summary }}
            <p class="mt-4 text-lg text-gray-700">{{ . }}</p>
          {{ end }}
        </header>

        <div class="prose max-w-none">
          {{ .Content }}
        </div>

        <footer class="mt-10 border-t pt-6">
          {{ with .Params.tags }}
            <div class="flex flex-wrap gap-2 text-sm">
              {{ range . }}
                <a href="{{ "/tags/" | relURL }}{{ . | urlize }}/" class="rounded-full bg-gray-100 px-3 py-1 hover:bg-gray-200">#{{ . }}</a>
              {{ end }}
            </div>
          {{ end }}
          <div class="mt-6 text-sm text-gray-500">
            Need help? <a href="/contact/" class="underline">Request a quote</a>.
          </div>
        </footer>

        <nav class="mt-12 grid grid-cols-2 gap-4">
          {{ with .PrevInSection }}
            <a href="{{ .RelPermalink }}" class="rounded-lg border p-4 hover:bg-gray-50">← {{ .Title }}</a>
          {{ end }}
          {{ with .NextInSection }}
            <a href="{{ .RelPermalink }}" class="rounded-lg border p-4 text-right hover:bg-gray-50">{{ .Title }} →</a>
          {{ end }}
        </nav>
      </div>
    </div>
  {{ else }}
    <!-- Fallback: no cover image, single column -->
    <div class="mx-auto max-w-3xl">
      <header class="mb-8">
        <a href="/blog/" class="text-sm text-gray-500 hover:underline">← Back to Blog</a>
        <h1 class="mt-2 text-4xl font-bold tracking-tight">{{ .Title }}</h1>
        <div class="mt-2 text-sm text-gray-500">
          <time datetime="{{ .Date }}">{{ .Date.Format "Jan 2, 2006" }}</time>
          <span aria-hidden="true"> • </span>{{ .ReadingTime }} min read
        </div>
        {{ with .Params.summary }}
          <p class="mt-4 text-lg text-gray-700">{{ . }}</p>
        {{ end }}
      </header>

      <div class="prose max-w-none">
        {{ .Content }}
      </div>

      <footer class="mt-10 border-t pt-6">
        {{ with .Params.tags }}
          <div class="flex flex-wrap gap-2 text-sm">
            {{ range . }}
              <a href="{{ "/tags/" | relURL }}{{ . | urlize }}/" class="rounded-full bg-gray-100 px-3 py-1 hover:bg-gray-200">#{{ . }}</a>
            {{ end }}
          </div>
        {{ end }}
        <div class="mt-6 text-sm text-gray-500">
          Need help? <a href="/contact/" class="underline">Request a quote</a>.
        </div>
      </footer>

      <nav class="mt-12 grid grid-cols-2 gap-4">
        {{ with .PrevInSection }}
          <a href="{{ .RelPermalink }}" class="rounded-lg border p-4 hover:bg-gray-50">← {{ .Title }}</a>
        {{ end }}
        {{ with .NextInSection }}
          <a href="{{ .RelPermalink }}" class="rounded-lg border p-4 text-right hover:bg-gray-50">{{ .Title }} →</a>
        {{ end }}
      </nav>
    </div>
  {{ end }}
</article>
{{ end }}
